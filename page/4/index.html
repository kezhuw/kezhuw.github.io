<!DOCTYPE html>
<html lang="default,en-US,en,zh-CN,default">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.kezhuw.name","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Recording">
<meta property="og:url" content="http://blog.kezhuw.name/page/4/index.html">
<meta property="og:site_name" content="Recording">
<meta property="og:locale">
<meta property="article:author" content="Kezhu Wang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://blog.kezhuw.name/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'default'
  };
</script>

  <title>Recording</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="Recording" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Recording</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Commit volatile memory to persistent append-only log</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-links">

    <a href="/links/" rel="section"><i class="links fa-fw"></i>Links</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default,en-US,en,zh-CN,default">
    <link itemprop="mainEntityOfPage" href="http://blog.kezhuw.name/2014/03/23/lua-coroutine-and-csharp-async/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Kezhu Wang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Recording">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2014/03/23/lua-coroutine-and-csharp-async/" class="post-title-link" itemprop="url">Lua coroutine 和 C# async</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: Mar 23 2014 22:45:44" itemprop="dateCreated datePublished" datetime="2014-03-23T22:45:44+08:00">Mar 23 2014</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: Dec 21 2014 22:46:42" itemprop="dateModified" datetime="2014-12-21T22:46:42+08:00">Dec 21 2014</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="lua-coroutine">Lua coroutine</h2>
<p>Lua coroutine 是<a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Computer_multitasking#Cooperative_multitasking.2Ftime-sharing">协作式多任务</a>的一种实现。coroutine
经常被 C/C++ 这类没用原生轻量级多任务实现的宿主语言通过异步方式实现 Lua
层的同步调用。</p>
<p>这种同步调用的流程：</p>
<pre><code>val, err = synchronous_call_in_lua(...)    -- function call in lua coroutine
    ==&gt; coroutine.yield
        ==&gt; C/C++ 发起异步请求会话
        ==| (time consumed)
        ==| C/C++ 异步会话完成（消息/回调）
    &lt;== coroutine.resume
val, err = ... -- &lt;== return from function
do_someting(...)</code></pre>
<p>这个流程很像阻塞式的系统调用：</p>
<pre><code>n = read(fd, buf, len)        // system call in userland
    ==&gt; syscallenter(...)     // in kernel mode
        |=&gt; sys_read(...)     // in system call
        |== kernel activity   // asynchronous wait if data is not available yet
        |==
    &lt;== syscallret(...)       // return from syscall
n = ...                       // return from read in userland</code></pre>
<h2 id="c-asyncawait">C# async/await</h2>
<p>async/await 是 C# 5
引入的，用来简化异步编程的设施，其本质是由编译器实施的 <a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Continuation-passing_style">CPS</a>
变换。</p>
<blockquote>
<p>C# 5.0 introduces the async and await keywords. These keywords let
you write asynchronous code that has the same structure and simplicity
as synchronous code, as well as eliminating the “plumbing” of
asynchronous programming. The await keyword simplifies the attaching of
continuations.</p>
</blockquote>
<p>即将如下代码：</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2014/03/23/lua-coroutine-and-csharp-async/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default,en-US,en,zh-CN,default">
    <link itemprop="mainEntityOfPage" href="http://blog.kezhuw.name/2013/12/14/two-arguments-version-accumulate/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Kezhu Wang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Recording">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2013/12/14/two-arguments-version-accumulate/" class="post-title-link" itemprop="url">两参数版本的 std::accumulate</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: Dec 14 2013 3:08:37" itemprop="dateCreated datePublished" datetime="2013-12-14T03:08:37+08:00">Dec 14 2013</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: Dec 21 2014 22:46:46" itemprop="dateModified" datetime="2014-12-21T22:46:46+08:00">Dec 21 2014</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>C++11 的 auto 和 decltype 可以做 “返回值类型推断”。</p>
<p>我写了个两参数版本的 <a target="_blank" rel="noopener" href="https://github.com/kezhuw/recipes/blob/master/cpp/accumulate.cpp">std::accumulate</a>
。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;numeric&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;type_traits&gt;</span></span></span><br><span class="line"><span class="keyword">namespace</span> std &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> InputIt&gt;</span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">accumulate</span><span class="params">(InputIt begin, InputIt end)</span> -&gt; <span class="keyword">typename</span> std::remove_reference&lt;<span class="title">decltype</span><span class="params">(*begin)</span>&gt;::type </span>&#123;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">typename</span> std::remove_reference&lt;<span class="keyword">decltype</span>(*begin)&gt;::type ValueType;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">accumulate</span>(begin, end, <span class="built_in">ValueType</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配上点测试代码。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iterator&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;initializer_list&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> ValueType&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test</span><span class="params">(std::vector&lt;ValueType&gt; <span class="type">const</span>&amp; v)</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;=========================n&quot;</span>;</span><br><span class="line">    std::<span class="built_in">copy</span>(std::<span class="built_in">begin</span>(v), std::<span class="built_in">end</span>(v), std::<span class="built_in">ostream_iterator</span>&lt;ValueType&gt;(std::cout, <span class="string">&quot;, &quot;</span>));</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> sum = std::<span class="built_in">accumulate</span>(std::<span class="built_in">begin</span>(v), std::<span class="built_in">end</span>(v));</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;sum = &quot;</span> &lt;&lt; sum &lt;&lt; <span class="string">&quot;n&quot;</span>;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;=========================nn&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> ValueType&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test</span><span class="params">(std::initializer_list&lt;ValueType&gt;&amp;&amp; values)</span> </span>&#123;</span><br><span class="line">    <span class="function">std::vector&lt;ValueType&gt; <span class="title">v</span><span class="params">(std::forward&lt;std::initializer_list&lt;ValueType&gt;&gt;(values))</span></span>;</span><br><span class="line">    <span class="built_in">test</span>(v);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span></span></span><br><span class="line"><span class="function"><span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">test</span>&lt;<span class="type">int</span>&gt;(std::vector&lt;<span class="type">int</span>&gt;&#123;&#125;);</span><br><span class="line">    <span class="built_in">test</span>&lt;<span class="type">int</span>&gt;(&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;);</span><br><span class="line">    <span class="built_in">test</span>&lt;<span class="type">int</span>&gt;(std::vector&lt;<span class="type">int</span>&gt;&#123;<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>&#125;);</span><br><span class="line">    <span class="built_in">test</span>&lt;<span class="type">double</span>&gt;(&#123;<span class="number">1.1</span>, <span class="number">1.2</span>, <span class="number">1.3</span>&#125;);</span><br><span class="line">    <span class="built_in">test</span>&lt;std::string&gt;(&#123;<span class="string">&quot;aa&quot;</span>, <span class="string">&quot;bb&quot;</span>, <span class="string">&quot;cc&quot;</span>, <span class="string">&quot;dd&quot;</span>&#125;);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;cpp : &quot;</span> &lt;&lt; __cplusplus &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>EOF</p>

          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2013/12/14/two-arguments-version-accumulate/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default,en-US,en,zh-CN,default">
    <link itemprop="mainEntityOfPage" href="http://blog.kezhuw.name/2013/12/01/game-drop-item/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Kezhu Wang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Recording">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2013/12/01/game-drop-item/" class="post-title-link" itemprop="url">游戏掉落表设计</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: Dec 1 2013 12:18:31" itemprop="dateCreated datePublished" datetime="2013-12-01T12:18:31+08:00">Dec 1 2013</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: Apr 6 2015 1:45:22" itemprop="dateModified" datetime="2015-04-06T01:45:22+08:00">Apr 6 2015</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>游戏中各种怪物都会有自己的掉落物品列表。</p>
<p>最原始的掉落列表设计可能就是，掉落金钱，掉落经验，掉落物品1（id +
数量），掉落物品2 ……
。我觉得这样的掉落表设计不够灵活，不能很好的对不同种类（分类？）的物品做不同的处理。</p>
<p>一种更好的掉落表可能是这样的：掉落分类1，掉落 id
1，掉落数量1，掉落分类2，掉落 id 2，掉落数量2，……</p>
<p>这样程序可以对不同的掉落分类进行不同的处理，并且 id
的含义可以局限于分类之下，例如：可以将“分类1”视为虚拟物品，“分类2”视为普通物品，“分类3”视为某种特殊物品，等等。</p>

          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2013/12/01/game-drop-item/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default,en-US,en,zh-CN,default">
    <link itemprop="mainEntityOfPage" href="http://blog.kezhuw.name/2013/07/15/address-const-expression/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Kezhu Wang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Recording">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2013/07/15/address-const-expression/" class="post-title-link" itemprop="url">地址常量表达式</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: Jul 15 2013 7:07:58" itemprop="dateCreated datePublished" datetime="2013-07-15T07:07:58+08:00">Jul 15 2013</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: Dec 21 2014 20:45:38" itemprop="dateModified" datetime="2014-12-21T20:45:38+08:00">Dec 21 2014</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>C
语言中具有静态生存周期的变量的初始化器必须是常量表达式。当初始化器不是常量表达式时，gcc
和 clang 的报错信息不尽相同。</p>
<p>gcc 的报错信息是 <q>error: initializer element is not constant</q>
clang 的报错信息是 <q>error: initializer element is not a compile-time
constant</q></p>
<p>clang 用的是“编译时常量”(compile-time constant)，实际上 C99
标准里没有“编译时常量”这个概念，只有“常量表达式”。</p>
<blockquote>
<p>A constant expression can be evaluated during translation rather than
runtime, and accordingly may be used in any place that a constant may
be.</p>
</blockquote>
<p>C99 规定了初始化器中可用的常量表达式：</p>
<blockquote>
<p>More latitude is permitted for constant expressions in initializers.
Such a constant expression shall be, or evaluate to, one of the
following: * — an arithmetic constant expression, * — a null pointer
constant, * — an address constant, or * — an address constant for an
object type plus or minus an integer constant expression.</p>
<p>An address constant is a null pointer, a pointer to an lvalue
designating an object of static storage duration, or a pointer to a
function designator; it shall be created explicitly using the unary
&amp; operator or an integer constant cast to pointer type, or
implicitly by the use of an expression of array or function type. The
array-subscript [] and member-access . and -&gt; operators, the address
&amp; and indirection * unary operators, and pointer casts may be used
in the creation of an address constant, but the value of an object shall
not be accessed by use of these operators.</p>
</blockquote>
<p>也就是说，你可以在初始化器中使用变量、变量的成员和函数的地址，也可以在地址的基础上加上个偏移量。</p>
<p>"address constant" 不能算作 "compile-time constant"。
尽管编译器可能在生成 ELF
文件之时，就决定了变量的虚拟地址，但在作为共享库 (shared library)
被加载时或其他情况下，这些变量的虚拟地址最终还需要加载器 (loader)
的调整。对于这些变量地址的引用，需要加载器的重定位功能。</p>
<p>c99 标准对于 "address constant"
的运算只规定了可以加减整数常量表达式。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">uintptr_t</span> addr = (<span class="type">uintptr_t</span>)<span class="built_in">malloc</span> + (<span class="type">uintptr_t</span>)<span class="built_in">free</span> + <span class="number">0x2345</span>;</span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2013/07/15/address-const-expression/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default,en-US,en,zh-CN,default">
    <link itemprop="mainEntityOfPage" href="http://blog.kezhuw.name/2013/05/31/cpp-experience/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Kezhu Wang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Recording">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2013/05/31/cpp-experience/" class="post-title-link" itemprop="url">C++ 经验谈</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: May 31 2013 2:34:02" itemprop="dateCreated datePublished" datetime="2013-05-31T02:34:02+08:00">May 31 2013</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: Dec 21 2014 22:46:55" itemprop="dateModified" datetime="2014-12-21T22:46:55+08:00">Dec 21 2014</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>学习一门新的语言时，我觉得最重要的是学习该语言的惯例用法(idioms)，即其编程范式。</p>
<p>很遗憾的是 C++
是一门日渐进化并且日趋复杂的语言，是一个具有多重编程范型的语言，被视为一个语言联邦<a target="_blank" rel="noopener" href="http://blog.csdn.net/myan/article/details/1778843">1</a>。</p>
<p>即使这样，我认为在日常 C++
编程时，也应该选择一个相对固定的编程模型，实验并改进之。</p>
<p>在用 C++ 编程时，应该尽量保持谦卑、进取与怀疑。</p>
<p>下面主要记录一下我写 C++ 的不长的时间里的一些经验。</p>
<h2 id="避免编译时依赖">避免编译时依赖。</h2>
<p>C++ 没有现代的 package, import 机制，而是使用了继承自 C 的
<code>#include</code> 头文件包含机制。C++ 的复杂和 C 的编译模型导致了
C++ 项目冗长的编译时间。在其他语言中 import/require 可以解决的问题，在
C++ 中必须要程序员自己付出努力。[2]</p>
<p>隐式 (implicit)
的编译依赖不像头文件依赖会导致编译期的错误，却会在运行期招致不可预估的致命错误。比如，当你在编译单元
CompilationUnitA 中 <code>p = new(CompilationUnitB::ClassB)</code>
时，你已经埋下了一颗地雷。以后当你改变 CompilationUnitB::ClassB
的成员而导致其大小 (size) 变化时，你编译 CompilationUnitB ，链接
CompilationUnitA ，运行，然后不知何时那颗地雷就会炸掉。我觉得就
<code>new</code> 的编译期行为，C++
能做的更好，也应该做的更好。好吧，永远不要跨编译单元调用
<code>new</code> 。</p>
<p>虚函数调用、跨编译单元的栈上变量/全局变量同样是隐式的编译依赖。</p>
<h2 id="跨编译单元.so-.dll-.lib时区分接口与实现同一编译单元内不过度区分接口与实现">跨编译单元（.so,
.dll,
.lib）时，区分接口与实现;同一编译单元内，不过度区分接口与实现。</h2>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2013/05/31/cpp-experience/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Kezhu Wang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">27</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">27</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/kezhuw" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;kezhuw" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://book.douban.com/people/kezhuw/" title="Douban → https:&#x2F;&#x2F;book.douban.com&#x2F;people&#x2F;kezhuw&#x2F;" rel="noopener" target="_blank"><i class="book fa-fw"></i>Douban</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.linkedin.com/in/kezhuw/" title="LinkedIn → https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;kezhuw&#x2F;" rel="noopener" target="_blank"><i class="linkedin fa-fw"></i>LinkedIn</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/kezhuw" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;kezhuw" rel="noopener" target="_blank"><i class="twitter fa-fw"></i>Twitter</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2012 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Kezhu Wang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
